import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  Pressable,
  ScrollView,
  Dimensions,
  SafeAreaView,
} from 'react-native';
import * as Animatable from 'react-native-animatable';
import * as Speech from 'expo-speech';
import * as Haptics from 'expo-haptics';
import { useAuth } from '../providers/AuthProvider';
import { COLORS, TYPOGRAPHY, SPACING, BORDER_RADIUS } from '../config/theme';
import GradientBackground from '../components/GradientBackground';
import AnimatedDidiAvatar from '../components/AnimatedDidiAvatar';

const { width, height } = Dimensions.get('window');

// Engaging Welcome Flow Steps
const WELCOME_STEPS = [
  {
    id: 'welcome',
    title: 'рджреАрджреАрдбрд╛рдпрд▓ рдореЗрдВ рдЖрдкрдХрд╛ рд╕реНрд╡рд╛рдЧрдд рд╣реИ! ЁЯЩП',
    subtitle: 'Welcome to DidiDial!',
    description: 'рдореИрдВ рджреАрджреА рд╣реВрдВ! рдореИрдВ рдЖрдкрдХреА рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рджреЛрд╕реНрдд рдФрд░ рдЧреБрд░реБ рдмрдирдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВред рд╕рд╛рде рдорд┐рд▓рдХрд░ рд╣рдо рдмрд╣реБрдд рдХреБрдЫ рд╕реАрдЦреЗрдВрдЧреЗ!',
    icon: 'ЁЯМЯ',
    voiceText: 'рдирдорд╕реНрддреЗ! рдореИрдВ рджреАрджреА рд╣реВрдВред рдореИрдВ рдЖрдкрдХреА рд╕рдмрд╕реЗ рдЕрдЪреНрдЫреА рджреЛрд╕реНрдд рдмрдиреВрдВрдЧреА рдФрд░ рдЖрдкрдХреЛ рдмрд╣реБрдд рдХреБрдЫ рд╕рд┐рдЦрд╛рдКрдВрдЧреАред',
    action: 'continue'
  },
  {
    id: 'excitement',
    title: 'рдЖрдк рдХрд┐рддрдиреА рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реИрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП? ЁЯЪА',
    subtitle: 'How excited are you to learn?',
    description: 'рдореБрдЭреЗ рдмрддрд╛рдЗрдП рдХрд┐ рдЖрдк рдХрд┐рддрдиреА рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реИрдВ рдирдИ рдЪреАрдЬреЗрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП!',
    icon: 'ЁЯОп',
    voiceText: 'рдЖрдк рдХрд┐рддрдиреА рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реИрдВ рдирдИ рдЪреАрдЬреЗрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП? рдореБрдЭреЗ рдмрддрд╛рдЗрдП!',
    action: 'select_excitement'
  },
  {
    id: 'learning_style',
    title: 'рдЖрдк рдХреИрд╕реЗ рд╕реАрдЦрдирд╛ рдкрд╕рдВрдж рдХрд░рддреА рд╣реИрдВ? ЁЯОи',
    subtitle: 'How do you like to learn?',
    description: 'рд╣рд░ рдЗрдВрд╕рд╛рди рдЕрд▓рдЧ рддрд░реАрдХреЗ рд╕реЗ рд╕реАрдЦрддрд╛ рд╣реИред рдЖрдкрдХрд╛ рдкрд╕рдВрджреАрджрд╛ рддрд░реАрдХрд╛ рдХреМрди рд╕рд╛ рд╣реИ?',
    icon: 'ЁЯза',
    voiceText: 'рдЖрдк рдХреИрд╕реЗ рд╕реАрдЦрдирд╛ рдкрд╕рдВрдж рдХрд░рддреА рд╣реИрдВ? рдореБрдЭреЗ рдмрддрд╛рдЗрдП рддрд╛рдХрд┐ рдореИрдВ рдЖрдкрдХреА рдорджрдж рдХрд░ рд╕рдХреВрдВред',
    action: 'select_learning_style'
  },
  {
    id: 'daily_goal',
    title: 'рд░реЛрдЬ рдХрд┐рддрдирд╛ рд╕рдордп рджреЗ рд╕рдХрддреА рд╣реИрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП? тП░',
    subtitle: 'How much time can you dedicate daily?',
    description: 'рдереЛрдбрд╝рд╛ рд╕рд╛ рд╕рдордп рднреА рдХрд╛рдлреА рд╣реИ! рдмрддрд╛рдЗрдП рдЖрдк рд░реЛрдЬ рдХрд┐рддрдирд╛ рд╕рдордп рджреЗ рд╕рдХрддреА рд╣реИрдВред',
    icon: 'тП░',
    voiceText: 'рдЖрдк рд░реЛрдЬ рдХрд┐рддрдирд╛ рд╕рдордп рджреЗ рд╕рдХрддреА рд╣реИрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП? рдереЛрдбрд╝рд╛ рд╕рд╛ рд╕рдордп рднреА рдмрд╣реБрдд рд╣реИред',
    action: 'select_time_commitment'
  },
  {
    id: 'motivation',
    title: 'рдЖрдкрдХреЛ рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдХреНрдпрд╛ рдкреНрд░реЗрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ? ЁЯТк',
    subtitle: 'What motivates you the most?',
    description: 'рдЬрдм рдЖрдк рдХреБрдЫ рдирдпрд╛ рд╕реАрдЦрддреА рд╣реИрдВ рддреЛ рдЖрдкрдХреЛ рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдЦреБрд╢реА рдХрд┐рд╕ рдмрд╛рдд рд╕реЗ рдорд┐рд▓рддреА рд╣реИ?',
    icon: 'ЁЯТЦ',
    voiceText: 'рдЖрдкрдХреЛ рд╕рдмрд╕реЗ рдЬреНрдпрд╛рджрд╛ рдХреНрдпрд╛ рдкреНрд░реЗрд░рд┐рдд рдХрд░рддрд╛ рд╣реИ? рдХреНрдпрд╛ рдЖрдкрдХреЛ рдЦреБрд╢реА рджреЗрддрд╛ рд╣реИ?',
    action: 'select_motivation'
  },
  {
    id: 'support_system',
    title: 'рдЖрдк рдХрд┐рд╕рдХреЗ рд╕рд╛рде рдЕрдкрдиреА рд╕рдлрд▓рддрд╛ рд╕рд╛рдЭрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреА? ЁЯСе',
    subtitle: 'Who would you like to share your success with?',
    description: 'рдЬрдм рдЖрдк рдХреБрдЫ рдирдпрд╛ рд╕реАрдЦреЗрдВрдЧреА рддреЛ рдХрд┐рд╕реЗ рдмрддрд╛рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреА? рдпрд╣ рдЖрдкрдХреЛ рдФрд░ рднреА рдкреНрд░реЗрд░рд┐рдд рдХрд░реЗрдЧрд╛!',
    icon: 'ЁЯдЧ',
    voiceText: 'рдЖрдк рдЕрдкрдиреА рд╕рдлрд▓рддрд╛ рдХрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣реЗрдВрдЧреА? рдкрд░рд┐рд╡рд╛рд░, рджреЛрд╕реНрдд рдпрд╛ рд╕рдореБрджрд╛рдп рдХреЗ рд╕рд╛рде?',
    action: 'select_support'
  },
  {
    id: 'ready',
    title: 'рддреИрдпрд╛рд░ рд╣реИрдВ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП? ЁЯОЙ',
    subtitle: 'Ready to start your journey?',
    description: 'рд╡рд╛рд╣! рдЕрдм рдореИрдВ рдЖрдкрдХреЛ рдмрд╣реБрдд рдЕрдЪреНрдЫреА рддрд░рд╣ рдЬрд╛рдирддреА рд╣реВрдВред рдЪрд▓рд┐рдП рдЕрдм рд╕рд╛рде рдорд┐рд▓рдХрд░ рд╕реАрдЦрддреЗ рд╣реИрдВ!',
    icon: 'ЁЯЪА',
    voiceText: 'рдмрд╣реБрдд рдмрдврд╝рд┐рдпрд╛! рдЕрдм рд╣рдо рддреИрдпрд╛рд░ рд╣реИрдВред рдЪрд▓рд┐рдП рдЕрдм рд╕рд╛рде рдорд┐рд▓рдХрд░ рд╕реАрдЦрддреЗ рд╣реИрдВ!',
    action: 'complete'
  }
];

// Engaging Options for Each Step
const EXCITEMENT_OPTIONS = [
  { id: 'very_excited', name: 'рдмрд╣реБрдд рдЙрддреНрд╕рд╛рд╣рд┐рдд! ЁЯФе', icon: 'ЁЯФе', description: 'рдореИрдВ рдмрд╣реБрдд рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реВрдВ!' },
  { id: 'excited', name: 'рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реВрдВ ЁЯШК', icon: 'ЁЯШК', description: 'рдореИрдВ рдЙрддреНрд╕рд╛рд╣рд┐рдд рд╣реВрдВ рд╕реАрдЦрдиреЗ рдХреЗ рд▓рд┐рдП' },
  { id: 'curious', name: 'рдЬрд┐рдЬреНрдЮрд╛рд╕реБ рд╣реВрдВ ЁЯдФ', icon: 'ЁЯдФ', description: 'рдореБрдЭреЗ рдЬрд╛рдирдирд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╣реЛрдЧрд╛' },
  { id: 'nervous', name: 'рдереЛрдбрд╝реА рдШрдмрд░рд╛рд╣рдЯ рд╣реИ ЁЯШЕ', icon: 'ЁЯШЕ', description: 'рдереЛрдбрд╝реА рдШрдмрд░рд╛рд╣рдЯ рд╣реИ рд▓реЗрдХрд┐рди рд╕реАрдЦрдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВ' }
];

const LEARNING_STYLE_OPTIONS = [
  { id: 'visual', name: 'рджреЗрдЦрдХрд░ рд╕реАрдЦрдирд╛ ЁЯСА', icon: 'ЁЯСА', description: 'рдореБрдЭреЗ рдЪрд┐рддреНрд░ рдФрд░ рд╡реАрдбрд┐рдпреЛ рдкрд╕рдВрдж рд╣реИрдВ' },
  { id: 'audio', name: 'рд╕реБрдирдХрд░ рд╕реАрдЦрдирд╛ ЁЯСВ', icon: 'ЁЯСВ', description: 'рдореБрдЭреЗ рдмрд╛рддрдЪреАрдд рдФрд░ рдЖрд╡рд╛рдЬрд╝ рдкрд╕рдВрдж рд╣реИ' },
  { id: 'hands_on', name: 'рдХрд░рдХреЗ рд╕реАрдЦрдирд╛ тЬЛ', icon: 'тЬЛ', description: 'рдореБрдЭреЗ рдЦреБрдж рдХрд░рдХреЗ рд╕реАрдЦрдирд╛ рдкрд╕рдВрдж рд╣реИ' },
  { id: 'mixed', name: 'рд╕рдм рддрд░реАрдХреЛрдВ рд╕реЗ ЁЯМЯ', icon: 'ЁЯМЯ', description: 'рдореБрдЭреЗ рд╕рднреА рддрд░реАрдХреЗ рдкрд╕рдВрдж рд╣реИрдВ' }
];

const TIME_COMMITMENT_OPTIONS = [
  { id: '5_minutes', name: '5 рдорд┐рдирдЯ рд░реЛрдЬ тЪб', icon: 'тЪб', description: 'рдмрд╕ 5 рдорд┐рдирдЯ рд░реЛрдЬ' },
  { id: '15_minutes', name: '15 рдорд┐рдирдЯ рд░реЛрдЬ тП░', icon: 'тП░', description: '15 рдорд┐рдирдЯ рдХрд╛ рд╕рдордп рджреЗ рд╕рдХрддреА рд╣реВрдВ' },
  { id: '30_minutes', name: '30 рдорд┐рдирдЯ рд░реЛрдЬ ЁЯУЪ', icon: 'ЁЯУЪ', description: 'рдЖрдзрд╛ рдШрдВрдЯрд╛ рд░реЛрдЬ рд╕реАрдЦреВрдВрдЧреА' },
  { id: 'flexible', name: 'рдЬрдм рд╕рдордп рдорд┐рд▓реЗ ЁЯХР', icon: 'ЁЯХР', description: 'рдЬрдм рднреА рд╕рдордп рдорд┐рд▓реЗрдЧрд╛ рд╕реАрдЦреВрдВрдЧреА' }
];

const MOTIVATION_OPTIONS = [
  { id: 'family', name: 'рдкрд░рд┐рд╡рд╛рд░ рдХреА рдЦреБрд╢реА ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж', icon: 'ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж', description: 'рдкрд░рд┐рд╡рд╛рд░ рдХреЛ рдЧрд░реНрд╡ рдорд╣рд╕реВрд╕ рдХрд░рд╛рдирд╛' },
  { id: 'independence', name: 'рдЖрддреНрдордирд┐рд░реНрднрд░рддрд╛ ЁЯТк', icon: 'ЁЯТк', description: 'рдЦреБрдж рдкрд░ рдирд┐рд░реНрднрд░ рд░рд╣рдирд╛' },
  { id: 'knowledge', name: 'рдЬреНрдЮрд╛рди рдХреА рдкреНрдпрд╛рд╕ ЁЯза', icon: 'ЁЯза', description: 'рдирдИ рдЪреАрдЬреЗрдВ рдЬрд╛рдирдиреЗ рдХрд╛ рд╢реМрдХ' },
  { id: 'helping_others', name: 'рджреВрд╕рд░реЛрдВ рдХреА рдорджрдж ЁЯдЭ', icon: 'ЁЯдЭ', description: 'рджреВрд╕рд░реЛрдВ рдХреА рдорджрдж рдХрд░рдирд╛' }
];

const SUPPORT_OPTIONS = [
  { id: 'family', name: 'рдкрд░рд┐рд╡рд╛рд░ рдХреЗ рд╕рд╛рде ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж', icon: 'ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж', description: 'рдЕрдкрдиреЗ рдкрд░рд┐рд╡рд╛рд░ рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд░реВрдВрдЧреА' },
  { id: 'friends', name: 'рджреЛрд╕реНрддреЛрдВ рдХреЗ рд╕рд╛рде ЁЯСн', icon: 'ЁЯСн', description: 'рдЕрдкрдиреА рд╕рд╣реЗрд▓рд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде' },
  { id: 'community', name: 'рд╕рдореБрджрд╛рдп рдХреЗ рд╕рд╛рде ЁЯПШя╕П', icon: 'ЁЯПШя╕П', description: 'рдЕрдкрдиреЗ рд╕рдореБрджрд╛рдп рдХреЗ рд╕рд╛рде' },
  { id: 'myself', name: 'рдЦреБрдж рдХреЗ рд╕рд╛рде ЁЯкЮ', icon: 'ЁЯкЮ', description: 'рдкрд╣рд▓реЗ рдЦреБрдж рдХреЛ рдЧрд░реНрд╡ рдорд╣рд╕реВрд╕ рдХрд░рд╛рдКрдВрдЧреА' }
];

const DREAM_OPTIONS = [
  { id: 'education', name: 'рд╢рд┐рдХреНрд╖рд╛ рдкреВрд░реА рдХрд░рдирд╛ ЁЯОУ', icon: 'ЁЯОУ', description: 'рдЕрдкрдиреА рдкрдврд╝рд╛рдИ рдкреВрд░реА рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВ' },
  { id: 'job', name: 'рдЕрдЪреНрдЫреА рдиреМрдХрд░реА рдкрд╛рдирд╛ ЁЯТ╝', icon: 'ЁЯТ╝', description: 'рдПрдХ рдЕрдЪреНрдЫреА рдиреМрдХрд░реА рдкрд╛рдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВ' },
  { id: 'business', name: 'рдЕрдкрдирд╛ рд╡реНрдпрд╡рд╕рд╛рдп рд╢реБрд░реВ рдХрд░рдирд╛ ЁЯПк', icon: 'ЁЯПк', description: 'рдЕрдкрдирд╛ рдЫреЛрдЯрд╛ рд╡реНрдпрд╡рд╕рд╛рдп рд╢реБрд░реВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВ' },
  { id: 'family', name: 'рдкрд░рд┐рд╡рд╛рд░ рдХреА рдорджрдж рдХрд░рдирд╛ ЁЯПа', icon: 'ЁЯПа', description: 'рдЕрдкрдиреЗ рдкрд░рд┐рд╡рд╛рд░ рдХреА рдмреЗрд╣рддрд░ рдорджрдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реВрдВ' }
];

export default function EnhancedWelcomeFlowScreen({ navigation }) {
  const { user, profile, updateUserProfile } = useAuth();
  const [currentStep, setCurrentStep] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [userPreferences, setUserPreferences] = useState({
    excitement: '',
    learningStyle: '',
    timeCommitment: '',
    motivation: '',
    support: '',
    dream: ''
  });
  const [avatarEmotion, setAvatarEmotion] = useState('welcoming');

  const currentStepData = WELCOME_STEPS[currentStep];

  useEffect(() => {
    // Auto-play voice introduction for each step
    const timer = setTimeout(() => {
      speakText(currentStepData.voiceText);
    }, 1000);

    return () => clearTimeout(timer);
  }, [currentStep]);

  const speakText = (text, onComplete = null) => {
    setIsPlaying(true);
    Speech.speak(text, {
      language: 'hi-IN',
      rate: 0.8,
      pitch: 1.1,
      onDone: () => {
        setIsPlaying(false);
        if (onComplete) onComplete();
      },
      onError: () => {
        setIsPlaying(false);
      }
    });
  };

  const handleNext = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    
    if (currentStep < WELCOME_STEPS.length - 1) {
      setCurrentStep(currentStep + 1);
      setAvatarEmotion('encouraging');
    } else {
      completeOnboarding();
    }
  };

  const handleBack = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
      setAvatarEmotion('neutral');
    }
  };

  const handleOptionSelect = (field, value) => {
    setUserPreferences(prev => ({ ...prev, [field]: value }));
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    setAvatarEmotion('happy');
    
    // Auto-advance after selection with a small delay
    setTimeout(() => {
      handleNext();
    }, 1500);
  };

  const completeOnboarding = async () => {
    try {
      if (!user) {
        console.error('No user found');
        return;
      }

      const updatedProfile = {
        ...userPreferences,
        welcomeCompleted: true,
        onboardingCompletedAt: Date.now(),
        language: 'hi-IN'
      };

      // Use the AuthProvider's updateUserProfile function which handles both local and remote updates
      await updateUserProfile(updatedProfile);

      const userName = profile?.name || user?.displayName || 'рдмрд╣рди';
      speakText(`рд╕реНрд╡рд╛рдЧрдд рд╣реИ ${userName}! рдЕрдм рдЖрдк рд╕реАрдЦрдирд╛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреА рд╣реИрдВред`);
      
      // The app will automatically re-render and show the home screen
      // once the profile is updated locally
      
    } catch (error) {
      console.error('Error completing onboarding:', error);
      // Even if there's an error, the profile should still be updated locally
      // and the app will proceed to the home screen automatically
    }
  };

  const getOptionsForCurrentStep = () => {
    switch (currentStepData.action) {
      case 'select_excitement':
        return EXCITEMENT_OPTIONS;
      case 'select_learning_style':
        return LEARNING_STYLE_OPTIONS;
      case 'select_time_commitment':
        return TIME_COMMITMENT_OPTIONS;
      case 'select_motivation':
        return MOTIVATION_OPTIONS;
      case 'select_support':
        return SUPPORT_OPTIONS;
      case 'select_dream':
        return DREAM_OPTIONS;
      default:
        return [];
    }
  };

  const getFieldForCurrentStep = () => {
    switch (currentStepData.action) {
      case 'select_excitement':
        return 'excitement';
      case 'select_learning_style':
        return 'learningStyle';
      case 'select_time_commitment':
        return 'timeCommitment';
      case 'select_motivation':
        return 'motivation';
      case 'select_support':
        return 'support';
      case 'select_dream':
        return 'dream';
      default:
        return '';
    }
  };

  const renderStepContent = () => {
    const options = getOptionsForCurrentStep();
    const field = getFieldForCurrentStep();

    if (options.length === 0) {
      return null;
    }

    return (
      <View style={styles.optionsContainer}>
        {options.map((option) => (
          <Pressable
            key={option.id}
            style={[
              styles.optionCard,
              userPreferences[field] === option.id && styles.selectedOption
            ]}
            onPress={() => handleOptionSelect(field, option.id)}
          >
            <Text style={styles.optionIcon}>
              {option.icon}
            </Text>
            <View style={styles.optionContent}>
              <Text style={[
                styles.optionName,
                userPreferences[field] === option.id && styles.selectedOptionText
              ]}>
                {option.name}
              </Text>
              <Text style={[
                styles.optionDescription,
                userPreferences[field] === option.id && styles.selectedOptionDescription
              ]}>
                {option.description}
              </Text>
            </View>
            {userPreferences[field] === option.id && (
              <Text style={styles.checkMark}>тЬЕ</Text>
            )}
          </Pressable>
        ))}
      </View>
    );
  };

  const canProceed = () => {
    const field = getFieldForCurrentStep();
    if (!field) return true;
    return userPreferences[field] !== '';
  };

  return (
    <SafeAreaView style={styles.safeArea}>
      <GradientBackground colors={[COLORS.background.primary, COLORS.background.surface]}>
        <View style={styles.container}>
          {/* Progress Indicator */}
          <View style={styles.progressContainer}>
            <View style={styles.progressBar}>
              <View 
                style={[
                  styles.progressFill, 
                  { width: `${((currentStep + 1) / WELCOME_STEPS.length) * 100}%` }
                ]} 
              />
            </View>
            <Text style={styles.progressText}>
              {currentStep + 1} / {WELCOME_STEPS.length}
            </Text>
          </View>

          {/* Main Content */}
          <ScrollView 
            style={styles.scrollView}
            contentContainerStyle={styles.scrollContent}
            showsVerticalScrollIndicator={false}
            bounces={false}
          >
            {/* Didi Avatar */}
            <Animatable.View 
              key={`avatar-${currentStep}`}
              animation="zoomIn" 
              style={styles.avatarSection}
            >
              <AnimatedDidiAvatar
                isSpeaking={isPlaying}
                emotion={avatarEmotion}
                size={110}
              />
              <Text style={styles.didiMessage}>
                {isPlaying ? 'рджреАрджреА рдмреЛрд▓ рд░рд╣реА рд╣реИрдВ...' : 'рджреАрджреА рдЖрдкрдХреА рдорджрдж рдХрд░ рд░рд╣реА рд╣реИрдВ'}
              </Text>
            </Animatable.View>

            {/* Step Content */}
            <Animatable.View 
              key={`step-${currentStep}`}
              animation="fadeInUp" 
              style={styles.stepContainer}
            >
              <Text style={styles.stepIcon}>{currentStepData.icon}</Text>
              <Text style={styles.stepTitle}>{currentStepData.title}</Text>
              <Text style={styles.stepSubtitle}>{currentStepData.subtitle}</Text>
              <Text style={styles.stepDescription}>{currentStepData.description}</Text>
              
              {renderStepContent()}
            </Animatable.View>
          </ScrollView>

          {/* Navigation Controls */}
          <View style={styles.navigationContainer}>
            <Pressable 
              style={[
                styles.navButton, 
                styles.backButton, 
                currentStep === 0 && styles.disabledButton
              ]}
              onPress={handleBack}
              disabled={currentStep === 0}
            >
              <Text style={[
                styles.navButtonText,
                currentStep === 0 && styles.disabledButtonText
              ]}>
                тЖР рдкреАрдЫреЗ
              </Text>
            </Pressable>

            <Pressable 
              style={styles.voiceButton}
              onPress={() => speakText(currentStepData.voiceText)}
              disabled={isPlaying}
            >
              <Text style={styles.voiceButtonText}>
                {isPlaying ? 'ЁЯФК рдмреЛрд▓ рд░рд╣реА рд╣реИрдВ...' : 'ЁЯФК рдлрд┐рд░ рд╕реЗ рд╕реБрдиреЗрдВ'}
              </Text>
            </Pressable>

            <Pressable 
              style={[
                styles.navButton, 
                styles.nextButton, 
                !canProceed() && styles.disabledButton
              ]}
              onPress={handleNext}
              disabled={!canProceed()}
            >
              <Text style={[
                styles.navButtonText,
                styles.nextButtonText,
                !canProceed() && styles.disabledButtonText
              ]}>
                {currentStep === WELCOME_STEPS.length - 1 ? 'рд╢реБрд░реВ рдХрд░реЗрдВ ЁЯЪА' : 'рдЖрдЧреЗ тЖТ'}
              </Text>
            </Pressable>
          </View>
        </View>
      </GradientBackground>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: COLORS.background.primary,
  },
  container: {
    flex: 1,
  },
  progressContainer: {
    paddingHorizontal: SPACING.lg,
    paddingTop: SPACING.md,
    paddingBottom: SPACING.sm,
  },
  progressBar: {
    height: 6,
    backgroundColor: COLORS.neutral.gray[300],
    borderRadius: 3,
    marginBottom: SPACING.sm,
  },
  progressFill: {
    height: '100%',
    backgroundColor: COLORS.primary[500],
    borderRadius: 3,
  },
  progressText: {
    fontSize: TYPOGRAPHY.fontSize.sm,
    color: COLORS.text.secondary,
    textAlign: 'center',
    fontWeight: TYPOGRAPHY.fontWeight.medium,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: SPACING.lg,
    paddingBottom: SPACING.xl,
    flexGrow: 1,
  },
  avatarSection: {
    alignItems: 'center',
    marginBottom: SPACING.lg,
    paddingVertical: SPACING.md,
  },
  didiMessage: {
    fontSize: TYPOGRAPHY.fontSize.base,
    color: COLORS.text.secondary,
    textAlign: 'center',
    marginTop: SPACING.md,
    fontStyle: 'italic',
    fontWeight: TYPOGRAPHY.fontWeight.medium,
  },
  stepContainer: {
    alignItems: 'center',
    backgroundColor: COLORS.background.card,
    borderRadius: BORDER_RADIUS.xl,
    padding: SPACING.xl,
    borderWidth: 1,
    borderColor: COLORS.border,
    shadowColor: COLORS.shadow,
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 2,
  },
  stepIcon: {
    fontSize: 50,
    marginBottom: SPACING.lg,
  },
  stepTitle: {
    fontSize: TYPOGRAPHY.fontSize.xl,
    fontWeight: TYPOGRAPHY.fontWeight.bold,
    color: COLORS.text.primary,
    textAlign: 'center',
    marginBottom: SPACING.sm,
    lineHeight: 28,
  },
  stepSubtitle: {
    fontSize: TYPOGRAPHY.fontSize.base,
    color: COLORS.text.secondary,
    textAlign: 'center',
    marginBottom: SPACING.md,
    fontWeight: TYPOGRAPHY.fontWeight.medium,
  },
  stepDescription: {
    fontSize: TYPOGRAPHY.fontSize.base,
    color: COLORS.text.primary,
    textAlign: 'center',
    lineHeight: 24,
    marginBottom: SPACING.xl,
    fontWeight: TYPOGRAPHY.fontWeight.normal,
  },
  optionsContainer: {
    width: '100%',
    gap: SPACING.md,
  },
  optionCard: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: COLORS.background.surface,
    borderRadius: BORDER_RADIUS.lg,
    padding: SPACING.lg,
    borderWidth: 2,
    borderColor: COLORS.border,
    shadowColor: COLORS.shadow,
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
    elevation: 1,
  },
  selectedOption: {
    borderColor: COLORS.primary[500],
    backgroundColor: COLORS.primary[50],
    shadowColor: COLORS.primary[500],
    shadowOpacity: 0.2,
    elevation: 3,
  },
  optionIcon: {
    fontSize: 28,
    marginRight: SPACING.lg,
  },
  optionContent: {
    flex: 1,
  },
  optionName: {
    fontSize: TYPOGRAPHY.fontSize.lg,
    fontWeight: TYPOGRAPHY.fontWeight.bold,
    color: COLORS.text.primary,
    marginBottom: SPACING.xs,
    lineHeight: 22,
  },
  optionDescription: {
    fontSize: TYPOGRAPHY.fontSize.base,
    color: COLORS.text.secondary,
    lineHeight: 20,
    fontWeight: TYPOGRAPHY.fontWeight.normal,
  },
  selectedOptionText: {
    color: COLORS.primary[700],
  },
  selectedOptionDescription: {
    color: COLORS.primary[600],
  },
  checkMark: {
    fontSize: 24,
  },
  navigationContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: SPACING.lg,
    paddingVertical: SPACING.lg,
    backgroundColor: COLORS.background.card,
    borderTopWidth: 1,
    borderTopColor: COLORS.border,
  },
  navButton: {
    paddingVertical: SPACING.md,
    paddingHorizontal: SPACING.lg,
    borderRadius: BORDER_RADIUS.lg,
    minWidth: 80,
    alignItems: 'center',
  },
  backButton: {
    backgroundColor: COLORS.neutral.gray[200],
  },
  nextButton: {
    backgroundColor: COLORS.primary[500],
  },
  disabledButton: {
    opacity: 0.5,
  },
  navButtonText: {
    fontSize: TYPOGRAPHY.fontSize.base,
    fontWeight: TYPOGRAPHY.fontWeight.bold,
    color: COLORS.text.primary,
  },
  nextButtonText: {
    color: '#FFFFFF',
  },
  disabledButtonText: {
    color: COLORS.text.secondary,
  },
  voiceButton: {
    backgroundColor: COLORS.secondary[500],
    paddingVertical: SPACING.sm,
    paddingHorizontal: SPACING.md,
    borderRadius: BORDER_RADIUS.md,
    alignItems: 'center',
  },
  voiceButtonText: {
    fontSize: TYPOGRAPHY.fontSize.sm,
    fontWeight: TYPOGRAPHY.fontWeight.bold,
    color: COLORS.text.primary,
  },
});